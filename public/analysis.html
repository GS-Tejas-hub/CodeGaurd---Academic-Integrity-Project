<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CodeGuard - Analysis</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #f093fb;
            --success-color: #4facfe;
            --warning-color: #f093fb;
            --danger-color: #ff6b6b;
            --dark-color: #2c3e50;
            --light-color: #f8f9fa;
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --gradient-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-secondary: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-accent: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --shadow-light: 0 2px 10px rgba(0,0,0,0.1);
            --shadow-medium: 0 5px 20px rgba(0,0,0,0.15);
            --shadow-heavy: 0 10px 30px rgba(0,0,0,0.2);
            --border-radius: 15px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body {
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
            color: var(--text-primary);
            overflow-x: hidden;
        }

        /* Header & Navigation */
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            z-index: 1000;
            transition: var(--transition);
        }

        .nav-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            height: 70px;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5rem;
            font-weight: 800;
            color: var(--primary-color);
            text-decoration: none;
        }

        .logo i {
            font-size: 2rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .nav-menu {
            display: flex;
            list-style: none;
            gap: 30px;
        }

        .nav-link {
            text-decoration: none;
            color: var(--text-primary);
            font-weight: 500;
            transition: var(--transition);
            position: relative;
        }

        .nav-link:hover {
            color: var(--primary-color);
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 0;
            width: 0;
            height: 2px;
            background: var(--gradient-primary);
            transition: var(--transition);
        }

        .nav-link:hover::after {
            width: 100%;
        }

        .nav-cta {
            background: var(--gradient-primary);
            color: white;
            padding: 10px 20px;
            border-radius: 25px;
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
        }

        .nav-cta:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-medium);
        }

        /* Hero Section */
        .hero {
            min-height: 100vh;
            background: var(--gradient-primary);
            display: flex;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        .hero::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 1000 1000"><polygon fill="rgba(255,255,255,0.1)" points="0,1000 1000,0 1000,1000"/></svg>');
            background-size: cover;
        }

        .hero-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
            text-align: center;
            color: white;
            position: relative;
            z-index: 2;
        }

        .hero h1 {
            font-size: 4rem;
            font-weight: 900;
            margin-bottom: 20px;
            line-height: 1.2;
        }

        .hero p {
            font-size: 1.3rem;
            margin-bottom: 40px;
            opacity: 0.9;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }

        .hero-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .btn {
            padding: 15px 30px;
            border-radius: 50px;
            text-decoration: none;
            font-weight: 600;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 10px;
        }

        .btn-primary {
            background: white;
            color: var(--primary-color);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-heavy);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
        }

        /* Features Section */
        .features {
            padding: 100px 0;
            background: var(--light-color);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .section-header {
            text-align: center;
            margin-bottom: 80px;
        }

        .section-title {
            font-size: 3rem;
            font-weight: 800;
            margin-bottom: 20px;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .section-subtitle {
            font-size: 1.2rem;
            color: var(--text-secondary);
            max-width: 600px;
            margin: 0 auto;
        }

        .features-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 40px;
        }

        .feature-card {
            background: white;
            padding: 40px;
            border-radius: var(--border-radius);
            text-align: center;
            box-shadow: var(--shadow-light);
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .feature-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .feature-card:hover {
            transform: translateY(-10px);
            box-shadow: var(--shadow-heavy);
        }

        .feature-icon {
            width: 80px;
            height: 80px;
            background: var(--gradient-primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 20px;
            font-size: 2rem;
            color: white;
        }

        .feature-title {
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 15px;
            color: var(--text-primary);
        }

        .feature-description {
            color: var(--text-secondary);
            line-height: 1.6;
        }

        /* Stats Section */
        .stats {
            padding: 80px 0;
            background: var(--gradient-secondary);
            color: white;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 40px;
            text-align: center;
        }

        .stat-item h3 {
            font-size: 3rem;
            font-weight: 900;
            margin-bottom: 10px;
        }

        .stat-item p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        /* Footer */
        .footer {
            background: var(--dark-color);
            color: white;
            padding: 60px 0 20px;
        }

        .footer-content {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 40px;
            margin-bottom: 40px;
        }

        .footer-section h3 {
            font-size: 1.3rem;
            margin-bottom: 20px;
            color: var(--primary-color);
        }

        .footer-section p {
            color: #bdc3c7;
            line-height: 1.6;
        }

        .footer-bottom {
            border-top: 1px solid #34495e;
            padding-top: 20px;
            text-align: center;
            color: #bdc3c7;
        }

        .footer-bottom a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 600;
        }

        .footer-bottom a:hover {
            text-decoration: underline;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .nav-menu {
                display: none;
            }

            .hero h1 {
                font-size: 2.5rem;
            }

            .hero p {
                font-size: 1.1rem;
            }

            .hero-buttons {
                flex-direction: column;
                align-items: center;
            }

            .section-title {
                font-size: 2rem;
            }

            .features-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animations */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-in-up {
            animation: fadeInUp 0.6s ease-out;
        }

        /* Floating Elements */
        .floating {
            animation: floating 3s ease-in-out infinite;
        }

        @keyframes floating {
            0%, 100% { transform: translateY(0px); }
            50% { transform: translateY(-20px); }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <nav class="nav-container">
            <a href="/" class="logo">
                <i class="fas fa-shield-alt"></i>
                CodeGuard
            </a>
            <ul class="nav-menu">
                <li><a href="/" class="nav-link">Home</a></li>
                <li><a href="/about" class="nav-link">About</a></li>
                <li><a href="/dashboard" class="nav-link">Dashboard</a></li>
                <li><a href="/analysis" class="nav-link">Analysis</a></li>

            </ul>
            <a href="/analysis" class="nav-cta">Start Analysis</a>
        </nav>
    </header>

    <!-- Analysis Section -->
    <section class="hero">
        <div class="hero-content">
            <h1 class="animate-fade-in-up">Code Analysis</h1>
            <p class="animate-fade-in-up">Upload your code files, GitHub repository, or paste code directly to analyze for plagiarism and AI-generated content</p>
        </div>
    </section>

    <!-- Analysis Interface -->
    <section class="features">
        <div class="container">
            <div class="analysis-card" style="background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 30px;">
                <div class="card-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; text-align: center;">
                    <h2 style="font-size: 2rem; margin-bottom: 10px;"><i class="fas fa-upload"></i> Upload Your Code</h2>
                    <p style="opacity: 0.9; font-size: 1.1rem;">Choose your preferred method to analyze code for plagiarism and AI-generated content</p>
                </div>

                <div class="card-body" style="padding: 40px;">
                    <div class="upload-section" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 30px; margin-bottom: 40px;">
                        <div class="upload-method" onclick="selectMethod('file')" style="border: 2px dashed #e1e8ed; border-radius: 15px; padding: 40px 20px; text-align: center; transition: all 0.3s ease; cursor: pointer; background: #f8f9fa;">
                            <i class="fas fa-file-upload" style="font-size: 3rem; color: #667eea; margin-bottom: 20px;"></i>
                            <h3 style="font-size: 1.3rem; margin-bottom: 10px; color: #2c3e50;">Upload Files</h3>
                            <p style="color: #7f8c8d; line-height: 1.6;">Upload ZIP files or individual code files for analysis</p>
                            <input type="file" id="fileInput" style="display: none;" accept=".zip,.js,.jsx,.ts,.tsx,.py,.java,.cpp,.c,.cs,.php,.rb,.go,.rs,.swift,.kt,.scala,.html,.css,.scss,.sass,.sql,.sh,.bat,.ps1,.vue,.json,.xml,.yaml,.yml,.md,.txt" multiple>
                        </div>

                        <div class="upload-method" onclick="selectMethod('github')" style="border: 2px dashed #e1e8ed; border-radius: 15px; padding: 40px 20px; text-align: center; transition: all 0.3s ease; cursor: pointer; background: #f8f9fa;">
                            <i class="fab fa-github" style="font-size: 3rem; color: #667eea; margin-bottom: 20px;"></i>
                            <h3 style="font-size: 1.3rem; margin-bottom: 10px; color: #2c3e50;">GitHub Repository</h3>
                            <p style="color: #7f8c8d; line-height: 1.6;">Analyze code directly from a GitHub repository URL</p>
                            <input type="text" id="githubInput" style="display: none; width: 100%; padding: 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 1rem; margin-top: 20px;" placeholder="https://github.com/username/repository">
                        </div>

                        <div class="upload-method" onclick="selectMethod('code')" style="border: 2px dashed #e1e8ed; border-radius: 15px; padding: 40px 20px; text-align: center; transition: all 0.3s ease; cursor: pointer; background: #f8f9fa;">
                            <i class="fas fa-code" style="font-size: 3rem; color: #667eea; margin-bottom: 20px;"></i>
                            <h3 style="font-size: 1.3rem; margin-bottom: 10px; color: #2c3e50;">Paste Code</h3>
                            <p style="color: #7f8c8d; line-height: 1.6;">Paste your code directly into the text area</p>
                            <textarea id="codeInput" style="display: none; width: 100%; min-height: 200px; padding: 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-family: 'Courier New', monospace; font-size: 0.9rem; margin-top: 20px; resize: vertical;" placeholder="Paste your code here..."></textarea>
                            <select id="languageSelect" style="display: none; width: 100%; padding: 15px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 1rem; margin-top: 20px; background: white;">
                                <option value="">Select Language</option>
                                <option value="javascript">JavaScript</option>
                                <option value="typescript">TypeScript</option>
                                <option value="python">Python</option>
                                <option value="java">Java</option>
                                <option value="cpp">C++</option>
                                <option value="c">C</option>
                                <option value="csharp">C#</option>
                                <option value="php">PHP</option>
                                <option value="ruby">Ruby</option>
                                <option value="go">Go</option>
                                <option value="rust">Rust</option>
                                <option value="swift">Swift</option>
                                <option value="kotlin">Kotlin</option>
                                <option value="scala">Scala</option>
                                <option value="html">HTML</option>
                                <option value="css">CSS</option>
                                <option value="sql">SQL</option>
                                <option value="bash">Bash</option>
                            </select>
                        </div>
                    </div>

                    <div class="analysis-options" style="background: #f8f9fa; border-radius: 15px; padding: 30px; margin-bottom: 30px;">
                        <h3 style="margin-bottom: 20px; color: #2c3e50;">Analysis Options</h3>
                        <div class="options-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div class="option-item" style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="searchGitHub" checked style="width: 20px; height: 20px; accent-color: #667eea;">
                                <label for="searchGitHub" style="font-weight: 500; color: #2c3e50;">Search GitHub Repositories</label>
                            </div>
                            <div class="option-item" style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="searchStackOverflow" checked style="width: 20px; height: 20px; accent-color: #667eea;">
                                <label for="searchStackOverflow" style="font-weight: 500; color: #2c3e50;">Search Stack Overflow</label>
                            </div>
                            <div class="option-item" style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="searchWeb" checked style="width: 20px; height: 20px; accent-color: #667eea;">
                                <label for="searchWeb" style="font-weight: 500; color: #2c3e50;">Search Web Sources</label>
                            </div>
                            <div class="option-item" style="display: flex; align-items: center; gap: 10px;">
                                <input type="checkbox" id="detectAI" checked style="width: 20px; height: 20px; accent-color: #667eea;">
                                <label for="detectAI" style="font-weight: 500; color: #2c3e50;">Detect AI-Generated Code</label>
                            </div>
                        </div>
                    </div>

                    <button class="analyze-btn" onclick="startAnalysis()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: flex; align-items: center; gap: 10px; margin: 0 auto;">
                        <i class="fas fa-search"></i> Start Analysis
                    </button>
                </div>
            </div>

            <!-- Progress Section -->
            <div class="progress-section" id="progressSection" style="display: none; text-align: center; padding: 40px; background: white; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-bottom: 30px;">
                <div class="progress-text" style="font-size: 1.1rem; color: #2c3e50; margin-bottom: 10px;">Analyzing your code...</div>
                <div class="progress-percentage" id="progressPercentage" style="font-size: 1.5rem; font-weight: 700; color: #667eea;">0%</div>
                <div class="progress-bar" style="width: 100%; height: 20px; background: #e1e8ed; border-radius: 10px; overflow: hidden; margin: 20px 0;">
                    <div class="progress-fill" id="progressFill" style="height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); width: 0%; transition: width 0.3s ease;"></div>
                </div>
                <p>This may take a few minutes depending on the size of your project</p>
            </div>

            <!-- Results Section -->
            <div class="results-section" id="resultsSection" style="display: none; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.1); overflow: hidden; margin-bottom: 30px;">
                <div class="results-header" style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); color: white; padding: 30px; text-align: center;">
                    <h2 style="font-size: 2rem; margin-bottom: 10px;"><i class="fas fa-chart-bar"></i> Analysis Results</h2>
                    <p style="opacity: 0.9; font-size: 1.1rem;">Comprehensive plagiarism and AI detection report</p>
                </div>

                <div class="results-body" style="padding: 40px;">
                    <div class="summary-stats" id="summaryStats" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <!-- Summary stats will be populated here -->
                    </div>

                    <div class="file-results" id="fileResults" style="margin-top: 30px;">
                        <!-- File results will be populated here -->
                    </div>

                    <div class="download-section" style="text-align: center; padding: 30px; background: #f8f9fa; border-radius: 15px; margin-top: 30px;">
                        <h3>Download Complete Report</h3>
                        <p>Get a detailed PDF report with all findings and evidence</p>
                        <button class="download-btn" onclick="downloadReport()" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 15px 30px; border-radius: 50px; font-size: 1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; display: inline-flex; align-items: center; gap: 10px;">
                            <i class="fas fa-download"></i> Download PDF Report
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <!-- Stats Section -->
    <section class="stats">
        <div class="container">
            <div class="stats-grid">
                <div class="stat-item">
                    <h3>95%+</h3>
                    <p>Detection Accuracy</p>
                </div>
                <div class="stat-item">
                    <h3>10M+</h3>
                    <p>Code Files Analyzed</p>
                </div>
                <div class="stat-item">
                    <h3>50+</h3>
                    <p>Programming Languages</p>
                </div>
                <div class="stat-item">
                    <h3>24/7</h3>
                    <p>Support Available</p>
                </div>
            </div>
        </div>
    </section>

    <!-- Footer -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3>CodeGuard</h3>
                    <p>Leading the way in academic integrity with cutting-edge AI technology. Protecting education, one submission at a time.</p>
                </div>

                <div class="footer-section">
                    <h3>Features</h3>
                    <p>AI Detection</p>
                    <p>Plagiarism Check</p>
                    <p>GitHub Integration</p>
                    <p>PDF Reports</p>
                </div>
                <div class="footer-section">
                    <h3>Contact</h3>
                    <p>Email: demonking8660@gmail.com</p>
                    <p>Phone: +91 8660401238</p>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 CodeGuard. All rights reserved. | 
                   <span style="color: #f093fb;">Powered by Demon AI</span> | 
                   <span>Built by <a href="https://gs-tejas-hub.github.io/Demon-s-Portfolio/" target="_blank" style="color: #667eea;">Demon King</a></span>
                </p>
            </div>
        </div>
    </footer>

    <script>
        let currentMethod = null;
        let analysisData = null;

        function selectMethod(method) {
            // Reset all methods
            document.querySelectorAll('.upload-method').forEach(el => {
                el.classList.remove('active');
            });

            // Hide all inputs
            document.getElementById('fileInput').style.display = 'none';
            document.getElementById('githubInput').style.display = 'none';
            document.getElementById('codeInput').style.display = 'none';
            document.getElementById('languageSelect').style.display = 'none';

            // Activate selected method
            currentMethod = method;
            const methodElement = event.currentTarget;
            methodElement.classList.add('active');

            // Show relevant input
            switch (method) {
                case 'file':
                    document.getElementById('fileInput').style.display = 'block';
                    break;
                case 'github':
                    document.getElementById('githubInput').style.display = 'block';
                    break;
                case 'code':
                    document.getElementById('codeInput').style.display = 'block';
                    document.getElementById('languageSelect').style.display = 'block';
                    break;
            }
        }

        async function startAnalysis() {
            const analyzeBtn = document.querySelector('.analyze-btn');
            const progressSection = document.getElementById('progressSection');
            const resultsSection = document.getElementById('resultsSection');

            // Validate input
            if (!currentMethod) {
                showError('Please select an upload method');
                return;
            }

            let codeFiles = [];

            try {
                switch (currentMethod) {
                    case 'file':
                        const fileInput = document.getElementById('fileInput');
                        if (!fileInput.files.length) {
                            showError('Please select a file to upload');
                            return;
                        }
                        codeFiles = await uploadFiles(fileInput.files);
                        break;

                    case 'github':
                        const githubUrl = document.getElementById('githubInput').value.trim();
                        if (!githubUrl) {
                            showError('Please enter a GitHub repository URL');
                            return;
                        }
                        codeFiles = await processGitHubUrl(githubUrl);
                        break;

                    case 'code':
                        const code = document.getElementById('codeInput').value.trim();
                        const language = document.getElementById('languageSelect').value;
                        if (!code) {
                            showError('Please paste some code');
                            return;
                        }
                        if (!language) {
                            showError('Please select a programming language');
                            return;
                        }
                        codeFiles = [{
                            filename: `code.${getFileExtension(language)}`,
                            content: code,
                            language: language
                        }];
                        break;
                }

                if (codeFiles.length === 0) {
                    showError('No valid code files found');
                    return;
                }

                // Show progress
                analyzeBtn.disabled = true;
                progressSection.style.display = 'block';
                resultsSection.style.display = 'none';
                simulateProgress();

                // Get analysis options
                const options = {
                    searchGitHub: document.getElementById('searchGitHub').checked,
                    searchStackOverflow: document.getElementById('searchStackOverflow').checked,
                    searchWeb: document.getElementById('searchWeb').checked,
                    detectAI: document.getElementById('detectAI').checked
                };

                // Start analysis
                const response = await fetch('/api/analysis/analyze', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        codeFiles: codeFiles,
                        options: options
                    })
                });

                if (!response.ok) {
                    const errorText = await response.text();
                    throw new Error(`Analysis failed: ${response.status} - ${errorText}`);
                }

                const result = await response.json();
                analysisData = result.data;

                // Complete progress
                updateProgress(100);

                // Display results
                displayResults(analysisData);

            } catch (error) {
                showError('Analysis failed: ' + error.message);
            } finally {
                analyzeBtn.disabled = false;
                progressSection.style.display = 'none';
            }
        }

        async function uploadFiles(files) {
            const formData = new FormData();
            formData.append('codeFile', files[0]);

            const response = await fetch('/api/upload/file', {
                method: 'POST',
                body: formData
            });

            if (!response.ok) {
                throw new Error('File upload failed');
            }

            const result = await response.json();
            return result.data.files || [];
        }

        async function processGitHubUrl(url) {
            const response = await fetch('/api/upload/github', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ githubUrl: url })
            });

            if (!response.ok) {
                throw new Error('GitHub processing failed');
            }

            const result = await response.json();
            return result.data.files || [];
        }

        function displayResults(data) {
            const resultsSection = document.getElementById('resultsSection');
            const summaryStats = document.getElementById('summaryStats');
            const fileResults = document.getElementById('fileResults');

            // Display summary stats
            summaryStats.innerHTML = `
                <div class="stat-card" style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                    <div class="stat-value" style="font-size: 2rem; font-weight: 700; margin-bottom: 5px; color: ${getRiskColor(data.summary.plagiarismScore)};">${(data.summary.plagiarismScore * 100).toFixed(1)}%</div>
                    <div class="stat-label" style="color: #7f8c8d; font-weight: 500;">Plagiarism Score</div>
                </div>
                <div class="stat-card" style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                    <div class="stat-value" style="font-size: 2rem; font-weight: 700; margin-bottom: 5px; color: ${getRiskColor(data.summary.aiGeneratedScore)};">${(data.summary.aiGeneratedScore * 100).toFixed(1)}%</div>
                    <div class="stat-label" style="color: #7f8c8d; font-weight: 500;">AI-Generated Score</div>
                </div>
                <div class="stat-card" style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                    <div class="stat-value" style="font-size: 2rem; font-weight: 700; margin-bottom: 5px; color: #2c3e50;">${data.summary.totalMatches}</div>
                    <div class="stat-label" style="color: #7f8c8d; font-weight: 500;">Total Matches</div>
                </div>
                <div class="stat-card" style="background: #f8f9fa; padding: 20px; border-radius: 10px; text-align: center;">
                    <div class="stat-value" style="font-size: 2rem; font-weight: 700; margin-bottom: 5px; color: #2c3e50;">${data.summary.highRiskFiles.length}</div>
                    <div class="stat-label" style="color: #7f8c8d; font-weight: 500;">High Risk Files</div>
                </div>
            `;

            // Display file results
            fileResults.innerHTML = data.files.map(file => `
                <div class="file-item" style="background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 20px; border-left: 4px solid #667eea;">
                    <div class="file-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                        <div class="file-name" style="font-weight: 600; color: #2c3e50;">${file.filename}</div>
                        <div class="file-scores" style="display: flex; gap: 20px;">
                            <div class="score-item" style="text-align: center;">
                                <div class="score-value" style="font-size: 1.5rem; font-weight: 700; margin-bottom: 5px; color: ${getRiskColor(file.plagiarismScore)};">${(file.plagiarismScore * 100).toFixed(1)}%</div>
                                <div class="score-label" style="font-size: 0.9rem; color: #7f8c8d;">Plagiarism</div>
                            </div>
                            <div class="score-item" style="text-align: center;">
                                <div class="score-value" style="font-size: 1.5rem; font-weight: 700; margin-bottom: 5px; color: ${getRiskColor(file.aiGeneratedScore)};">${(file.aiGeneratedScore * 100).toFixed(1)}%</div>
                                <div class="score-label" style="font-size: 0.9rem; color: #7f8c8d;">AI-Generated</div>
                            </div>
                        </div>
                    </div>
                    ${file.matches.length > 0 ? `
                        <div class="matches-list" style="margin-top: 15px;">
                            <h4 style="margin-bottom: 10px; color: #2c3e50;">Found ${file.matches.length} potential matches:</h4>
                            ${file.matches.slice(0, 3).map(match => `
                                <div class="match-item" style="background: white; padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid #f39c12;">
                                    <div class="match-title" style="font-weight: 600; color: #2c3e50; margin-bottom: 5px;">${match.title || match.source}</div>
                                    <div class="match-details" style="font-size: 0.9rem; color: #7f8c8d;">
                                        Source: ${match.source} | Similarity: ${(match.similarity * 100).toFixed(1)}% | Risk: ${match.risk}
                                        ${match.link ? `<br><a href="${match.link}" target="_blank" style="color: #667eea; text-decoration: none; font-weight: 500;">View Source</a>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                            ${file.matches.length > 3 ? `<p>... and ${file.matches.length - 3} more matches</p>` : ''}
                        </div>
                    ` : '<p style="color: #27ae60;">✅ No plagiarism matches found.</p>'}
                </div>
            `).join('');

            resultsSection.style.display = 'block';
        }

        async function downloadReport() {
            if (!analysisData) {
                showError('No analysis data available');
                return;
            }

            try {
                const response = await fetch('/api/reports/generate', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        analysisData: analysisData,
                        options: {
                            includeCodeSnippets: true,
                            includeAIAnalysis: true,
                            includeSourceDetails: true
                        }
                    })
                });

                if (!response.ok) {
                    throw new Error('Report generation failed');
                }

                // Check if response is PDF (serverless) or JSON (development)
                const contentType = response.headers.get('content-type');
                
                if (contentType && contentType.includes('application/pdf')) {
                    // Direct PDF response (serverless environment)
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `codeguard_report_${Date.now()}.pdf`;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                } else {
                    // JSON response with download URL (development environment)
                    const result = await response.json();
                    
                    // Download the report
                    const downloadResponse = await fetch(result.data.downloadUrl);
                    const blob = await downloadResponse.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = result.data.filename;
                    document.body.appendChild(a);
                    a.click();
                    window.URL.revokeObjectURL(url);
                    document.body.removeChild(a);
                }

                showSuccess('Report downloaded successfully!');

            } catch (error) {
                showError('Failed to download report: ' + error.message);
            }
        }

        function getRiskColor(score) {
            if (score >= 0.8) return '#e74c3c';
            if (score >= 0.6) return '#f39c12';
            return '#27ae60';
        }

        function getFileExtension(language) {
            const extensions = {
                'javascript': 'js',
                'typescript': 'ts',
                'python': 'py',
                'java': 'java',
                'cpp': 'cpp',
                'c': 'c',
                'csharp': 'cs',
                'php': 'php',
                'ruby': 'rb',
                'go': 'go',
                'rust': 'rs',
                'swift': 'swift',
                'kotlin': 'kt',
                'scala': 'scala',
                'html': 'html',
                'css': 'css',
                'sql': 'sql',
                'bash': 'sh'
            };
            return extensions[language] || 'txt';
        }

        function simulateProgress() {
            let progress = 0;
            const interval = setInterval(() => {
                progress += Math.random() * 15;
                if (progress > 90) {
                    progress = 90;
                    clearInterval(interval);
                }
                updateProgress(progress);
            }, 800);
        }

        function updateProgress(percentage) {
            const progressFill = document.getElementById('progressFill');
            const progressPercentage = document.getElementById('progressPercentage');
            
            progressFill.style.width = percentage + '%';
            progressPercentage.textContent = Math.round(percentage) + '%';
        }

        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.style.cssText = 'padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; background: #fee; color: #e74c3c; border: 1px solid #fcc;';
            errorDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            document.querySelector('.card-body').insertBefore(errorDiv, document.querySelector('.analyze-btn'));
            setTimeout(() => errorDiv.remove(), 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.style.cssText = 'padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; align-items: center; gap: 10px; background: #efe; color: #27ae60; border: 1px solid #cfc;';
            successDiv.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            document.querySelector('.card-body').insertBefore(successDiv, document.querySelector('.analyze-btn'));
            setTimeout(() => successDiv.remove(), 5000);
        }

        // File input change handler
        document.getElementById('fileInput').addEventListener('change', function() {
            if (this.files.length > 0) {
                selectMethod('file');
            }
        });

        // Header scroll effect
        window.addEventListener('scroll', () => {
            const header = document.querySelector('.header');
            if (window.scrollY > 100) {
                header.style.background = 'rgba(255, 255, 255, 0.98)';
                header.style.boxShadow = '0 2px 20px rgba(0,0,0,0.1)';
            } else {
                header.style.background = 'rgba(255, 255, 255, 0.95)';
                header.style.boxShadow = 'none';
            }
        });
    </script>
</body>
</html> 